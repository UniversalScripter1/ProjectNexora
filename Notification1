local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")

local notif = {}
local active_notifications = {}
local SPACING = 70 

-- Function to handle the stacking movement
local function updateStack()
    for i, frame in ipairs(active_notifications) do
        -- Newer notifications stay at the bottom, older ones move UP
        local targetY = 0.8 - ((#active_notifications - i) * 0.1)
        local targetPos = UDim2.new(1, -340, targetY, 0)
        
        TweenService:Create(frame, TweenInfo.new(0.5, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {
            Position = targetPos
        }):Play()
    end
end

function notif:Notification(title, desc, font, font2, visibletime)
    -- Fallback to PlayerGui if CoreGui is restricted
    local parent = game:GetService("CoreGui") or Players.LocalPlayer:WaitForChild("PlayerGui")
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "NotifGui_" .. math.random(100, 999)
    screenGui.DisplayOrder = 999
    screenGui.Parent = parent

    local main = Instance.new("Frame")
    main.Name = "Main"
    main.BackgroundColor3 = Color3.fromRGB(17, 17, 17)
    main.Size = UDim2.new(0, 331, 0, 61)
    -- Start position: On the right side, mid-bottom
    main.Position = UDim2.new(1.2, 0, 0.8, 0) 
    main.BorderSizePixel = 0
    main.Parent = screenGui

    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 7)
    mainCorner.Parent = main

    local bar = Instance.new("Frame")
    bar.Name = "Bar"
    bar.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    bar.Size = UDim2.new(0, 10, 1, 0)
    bar.BorderSizePixel = 0
    bar.Parent = main

    local barCorner = Instance.new("UICorner")
    barCorner.CornerRadius = UDim.new(0, 7)
    barCorner.Parent = bar

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.Text = title or "Notification"
    titleLabel.Font = Enum.Font[font or "GothamBold"]
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.TextSize = 14
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.BackgroundTransparency = 1
    titleLabel.Position = UDim2.new(0, 20, 0.15, 0)
    titleLabel.Size = UDim2.new(0, 260, 0, 20)
    titleLabel.Parent = main

    local descLabel = Instance.new("TextLabel")
    descLabel.Name = "Description"
    descLabel.Text = desc or "Description goes here"
    descLabel.Font = Enum.Font[font2 or "Gotham"]
    descLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    descLabel.TextSize = 13
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.BackgroundTransparency = 1
    descLabel.Position = UDim2.new(0, 20, 0.5, 0)
    descLabel.Size = UDim2.new(0, 260, 0, 20)
    descLabel.Parent = main

    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "Close"
    closeBtn.Text = "Ã—"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 20
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.BackgroundTransparency = 1
    closeBtn.Position = UDim2.new(0.9, 0, 0, 0)
    closeBtn.Size = UDim2.new(0, 30, 1, 0)
    closeBtn.Parent = main

    -- Tracking Logic
    table.insert(active_notifications, main)
    updateStack()

    -- Dismiss Function
    local function dismiss()
        local index = table.find(active_notifications, main)
        if index then
            table.remove(active_notifications, index)
        end
        
        -- Move up and fade out
        local fadeTween = TweenService:Create(main, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
            Position = main.Position + UDim2.new(0, 0, -0.1, 0),
            BackgroundTransparency = 1
        })
        
        for _, v in ipairs(main:GetDescendants()) do
            if v:IsA("TextLabel") or v:IsA("TextButton") then
                TweenService:Create(v, TweenInfo.new(0.4), {TextTransparency = 1}):Play()
            elseif v:IsA("Frame") then
                TweenService:Create(v, TweenInfo.new(0.4), {BackgroundTransparency = 1}):Play()
            end
        end

        fadeTween:Play()
        fadeTween.Completed:Connect(function()
            screenGui:Destroy()
            updateStack()
        end)
    end

    closeBtn.MouseButton1Click:Connect(dismiss)
    task.delay(visibletime or 5, dismiss)
end

return notif
