local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")

local notif = {}
local active_notifications = {}

-- CONFIGURATION
local SPACING = 75 
local START_Y_OFFSET = 0.65 
local WIDTH = 320
local HEIGHT = 65
local ICON_SIZE = 35

-- THEME DEFINITIONS
local THEMES = {
    ["dark"] = {
        Background = Color3.fromRGB(30, 30, 30),
        Stroke = Color3.fromRGB(255, 255, 255),
        Title = Color3.fromRGB(255, 255, 255),
        Desc = Color3.fromRGB(180, 180, 180)
    },
    ["light"] = {
        Background = Color3.fromRGB(240, 240, 240),
        Stroke = Color3.fromRGB(0, 0, 0),
        Title = Color3.fromRGB(20, 20, 20),
        Desc = Color3.fromRGB(60, 60, 60)
    },
    ["ocean"] = {
        Background = Color3.fromRGB(10, 35, 65),
        Stroke = Color3.fromRGB(0, 180, 255),
        Title = Color3.fromRGB(255, 255, 255),
        Desc = Color3.fromRGB(150, 210, 255)
    },
    ["red"] = {
        Background = Color3.fromRGB(60, 10, 10),
        Stroke = Color3.fromRGB(255, 50, 50),
        Title = Color3.fromRGB(255, 255, 255),
        Desc = Color3.fromRGB(255, 180, 180)
    }
}

-- Pre-create container
local parent = (game:GetService("RunService"):IsStudio() and Players.LocalPlayer:WaitForChild("PlayerGui")) or 
               (game:GetService("CoreGui"):FindFirstChild("RobloxGui") and game:GetService("CoreGui")) or 
               Players.LocalPlayer:WaitForChild("PlayerGui")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MacNotif_Stack_System"
screenGui.DisplayOrder = 999
screenGui.ResetOnSpawn = false
screenGui.Parent = parent

local function updateStack()
    for i, frame in ipairs(active_notifications) do
        local stackIndex = #active_notifications - i
        local targetPos = UDim2.new(1, -(WIDTH + 20), START_Y_OFFSET, -(stackIndex * SPACING))
        
        TweenService:Create(frame, TweenInfo.new(0.4, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {
            Position = targetPos
        }):Play()
    end
end

function notif:Notification(title, desc, font, font2, visibletime, iconid, soundid, theme)
    local selectedTheme = THEMES[tostring(theme):lower()] or THEMES["dark"]
    local isDismissing = false -- Flag to prevent double-triggering

    -- Play Sound
    if soundid then
        local sound = Instance.new("Sound")
        sound.SoundId = "rbxassetid://" .. tostring(soundid):gsub("rbxassetid://", "")
        sound.Volume = 0.5
        sound.Parent = game:GetService("SoundService")
        sound:Play()
        task.delay(5, function() sound:Destroy() end)
    end

    -- Main Frame
    local main = Instance.new("Frame")
    main.Name = "NotifFrame"
    main.BackgroundColor3 = selectedTheme.Background
    main.BackgroundTransparency = 0.15
    main.Size = UDim2.new(0, WIDTH, 0, HEIGHT)
    main.Position = UDim2.new(1.3, 0, START_Y_OFFSET, 0) -- Start further off-screen
    main.BorderSizePixel = 0
    main.ClipsDescendants = true
    main.Parent = screenGui

    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 14)
    mainCorner.Parent = main

    local stroke = Instance.new("UIStroke")
    stroke.Color = selectedTheme.Stroke
    stroke.Transparency = 0.8
    stroke.Parent = main

    -- Icon Setup
    local textXOffset = 15
    if iconid and iconid ~= "" then
        local icon = Instance.new("ImageLabel")
        icon.Name = "Icon"
        icon.BackgroundTransparency = 1
        icon.Position = UDim2.new(0, 12, 0.5, -(ICON_SIZE/2))
        icon.Size = UDim2.new(0, ICON_SIZE, 0, ICON_SIZE)
        icon.Image = "rbxassetid://" .. tostring(iconid):gsub("rbxassetid://", "")
        icon.ImageColor3 = (theme == "light") and Color3.new(0,0,0) or Color3.new(1,1,1)
        icon.Parent = main
        textXOffset = 55
    end

    -- Text Elements
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = title
    titleLabel.Font = Enum.Font[font or "GothamBold"]
    titleLabel.TextColor3 = selectedTheme.Title
    titleLabel.TextSize = 14
    titleLabel.Position = UDim2.new(0, textXOffset, 0.2, 0)
    titleLabel.Size = UDim2.new(1, -(textXOffset + 10), 0, 20)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = main

    local descLabel = Instance.new("TextLabel")
    descLabel.Text = desc
    descLabel.Font = Enum.Font[font2 or "Gotham"]
    descLabel.TextColor3 = selectedTheme.Desc
    descLabel.TextSize = 12
    descLabel.Position = UDim2.new(0, textXOffset, 0.5, 0)
    descLabel.Size = UDim2.new(1, -(textXOffset + 10), 0, 20)
    descLabel.BackgroundTransparency = 1
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.Parent = main

    table.insert(active_notifications, main)
    updateStack()

    local function dismiss()
        if isDismissing then return end
        isDismissing = true
        
        local index = table.find(active_notifications, main)
        if index then
            table.remove(active_notifications, index)
            updateStack() -- Shift others up immediately
        end
        
        local dismissTween = TweenService:Create(main, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Position = main.Position + UDim2.new(0.6, 0, 0, 0),
            BackgroundTransparency = 1
        })
        
        -- Fade all elements
        for _, v in ipairs(main:GetDescendants()) do
            if v:IsA("TextLabel") then
                TweenService:Create(v, TweenInfo.new(0.3), {TextTransparency = 1}):Play()
            elseif v:IsA("ImageLabel") then
                TweenService:Create(v, TweenInfo.new(0.3), {ImageTransparency = 1}):Play()
            elseif v:IsA("UIStroke") then
                TweenService:Create(v, TweenInfo.new(0.3), {Transparency = 1}):Play()
            end
        end

        dismissTween:Play()
        dismissTween.Completed:Connect(function()
            main:Destroy()
        end)
    end

    -- Explicitly use visibletime or default to 5
    task.delay(tonumber(visibletime) or 5, dismiss)
end

return notif
    -- Play Sound
    if soundid then
        local sound = Instance.new("Sound")
        sound.SoundId = "rbxassetid://" .. tostring(soundid):gsub("rbxassetid://", "")
        sound.Volume = 0.5
        sound.Parent = game:GetService("SoundService")
        sound:Play()
        sound.Ended:Connect(function() sound:Destroy() end)
    end

    -- Main Frame
    local main = Instance.new("Frame")
    main.Name = "NotifFrame"
    main.BackgroundColor3 = selectedTheme.Background
    main.BackgroundTransparency = 0.15
    main.Size = UDim2.new(0, WIDTH, 0, HEIGHT)
    main.Position = UDim2.new(1.2, 0, START_Y_OFFSET, 0)
    main.BorderSizePixel = 0
    main.ClipsDescendants = true
    main.Parent = screenGui

    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 14)
    mainCorner.Parent = main

    local stroke = Instance.new("UIStroke")
    stroke.Color = selectedTheme.Stroke
    stroke.Transparency = 0.8
    stroke.Parent = main

    -- Icon Setup
    local textXOffset = 15
    if iconid then
        local icon = Instance.new("ImageLabel")
        icon.Name = "Icon"
        icon.BackgroundTransparency = 1
        icon.Position = UDim2.new(0, 12, 0.5, -(ICON_SIZE/2))
        icon.Size = UDim2.new(0, ICON_SIZE, 0, ICON_SIZE)
        icon.Image = "rbxassetid://" .. tostring(iconid):gsub("rbxassetid://", "")
        icon.ImageColor3 = (theme == "light") and Color3.new(0,0,0) or Color3.new(1,1,1) -- Tint icon if light mode
        icon.Parent = main
        textXOffset = 55
    end

    -- Title and Description
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = title
    titleLabel.Font = Enum.Font[font or "GothamBold"]
    titleLabel.TextColor3 = selectedTheme.Title
    titleLabel.TextSize = 14
    titleLabel.Position = UDim2.new(0, textXOffset, 0.2, 0)
    titleLabel.Size = UDim2.new(1, -(textXOffset + 10), 0, 20)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = main

    local descLabel = Instance.new("TextLabel")
    descLabel.Text = desc
    descLabel.Font = Enum.Font[font2 or "Gotham"]
    descLabel.TextColor3 = selectedTheme.Desc
    descLabel.TextSize = 12
    descLabel.Position = UDim2.new(0, textXOffset, 0.5, 0)
    descLabel.Size = UDim2.new(1, -(textXOffset + 10), 0, 20)
    descLabel.BackgroundTransparency = 1
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.Parent = main

    table.insert(active_notifications, main)
    updateStack()

    local function dismiss()
        local index = table.find(active_notifications, main)
        if index then
            table.remove(active_notifications, index)
            updateStack()
        end
        
        local dismissTween = TweenService:Create(main, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Position = main.Position + UDim2.new(0.5, 0, 0, 0),
            BackgroundTransparency = 1
        })
        
        for _, v in ipairs(main:GetDescendants()) do
            if v:IsA("TextLabel") or v:IsA("ImageLabel") then
                TweenService:Create(v, TweenInfo.new(0.3), {ImageTransparency = 1, TextTransparency = 1}):Play()
            elseif v:IsA("UIStroke") then
                TweenService:Create(v, TweenInfo.new(0.3), {Transparency = 1}):Play()
            end
        end

        dismissTween:Play()
        dismissTween.Completed:Connect(function() main:Destroy() end)
    end

    task.delay(visibletime or 5, dismiss)
end

return notif
