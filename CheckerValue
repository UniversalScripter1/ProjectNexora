-- SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local Trade = ReplicatedStorage:WaitForChild("Trade")

-- VALUE STORAGE & SCRAPER
local itemValues = {}

local function LoadWebsiteValues()
    local valuePages = {
        godly = "https://supremevaluelist.com/mm2/godlies.html",
        ancient = "https://supremevaluelist.com/mm2/ancients.html",
        unique = "https://supremevaluelist.com/mm2/uniques.html",
        classic = "https://supremevaluelist.com/mm2/vintages.html",
        chroma = "https://supremevaluelist.com/mm2/chromas.html"
    }

    local requestHeaders = {
        ["User-Agent"] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"
    }

    for category, url in pairs(valuePages) do
        task.spawn(function()
            local success, resp = pcall(function()
                return request({Url = url, Method = "GET", Headers = requestHeaders})
            end)
            
            if success and resp.Body then
                -- Match itemhead (Name) and itembody (Value)
                for title, body in resp.Body:gmatch("<div%s+class=['\"]itemhead['\"]>(.-)</div>%s*<div%s+class=['\"]itembody['\"]>(.-)</div>") do
                    local name = title:match("([^<]+)")
                    if name then
                        -- Clean the name: lowercase and remove " Click " suffix
                        name = name:gsub("%s+", " "):lower():match("^%s*(.-)%s*$")
                        name = name:split(" click ")[1]
                        
                        local valText = body:match("<b%s+class=['\"]itemvalue['\"]>([%d,%.]+)</b>")
                        if valText then
                            itemValues[name] = valText:gsub(",", "")
                        end
                    end
                end
            end
        end)
    end
end

-- Start loading values immediately
LoadWebsiteValues()

-- CLEANUP OLD VERSIONS
local oldGui = game:GetService("CoreGui"):FindFirstChild("TradeCoreGui")
if oldGui then oldGui:Destroy() end

-- MAIN GUI SETUP
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "TradeCoreGui"
ScreenGui.Parent = game:GetService("CoreGui")
ScreenGui.Enabled = false 

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.fromScale(0.5, 0.55)
MainFrame.Position = UDim2.fromScale(0.25, 0.22)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.Parent = ScreenGui
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

-- TITLE BAR
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 50)
Title.BackgroundTransparency = 1
Title.Text = "MM2 VALUE MONITOR (SUPREME)"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 20
Title.TextColor3 = Color3.new(1, 1, 1)
Title.Parent = MainFrame

-- COLUMN CREATOR
local function createColumn(titleText, posX)
    local Column = Instance.new("Frame")
    Column.Size = UDim2.new(0.46, 0, 0.8, 0)
    Column.Position = UDim2.new(posX, 0, 0.15, 0)
    Column.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    Column.Parent = MainFrame
    Instance.new("UICorner", Column).CornerRadius = UDim.new(0, 8)

    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(1, 0, 0, 40)
    Label.BackgroundTransparency = 1
    Label.Text = titleText
    Label.Font = Enum.Font.GothamBold
    Label.TextColor3 = Color3.new(1, 1, 1)
    Label.TextSize = 18
    Label.Parent = Column

    local List = Instance.new("ScrollingFrame")
    List.Size = UDim2.new(1, -10, 1, -50)
    List.Position = UDim2.new(0, 5, 0, 45)
    List.BackgroundTransparency = 1
    List.CanvasSize = UDim2.new(0, 0, 0, 0)
    List.AutomaticCanvasSize = Enum.AutomaticSize.Y
    List.ScrollBarThickness = 4
    List.Parent = Column

    local Layout = Instance.new("UIListLayout", List)
    Layout.Padding = UDim.new(0, 6)
    Layout.SortOrder = Enum.SortOrder.LayoutOrder
    
    return List
end

local OurList = createColumn("YOUR OFFER", 0.02)
local TheirList = createColumn("THEIR OFFER", 0.52)

-- ITEM CREATOR WITH VALUE CHECKING
local function createItem(id, amount, isOurs, itemType)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -8, 0, 45)
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    btn.Text = ""
    btn.Parent = nil

    -- Value Detection Logic
    local displayValue = ""
    local lowerID = tostring(id):lower()
    
    for webName, value in pairs(itemValues) do
        -- If ID is "Snowstorm" and WebName is "chroma snowstorm", this matches
        if webName:find(lowerID) or lowerID:find(webName) then
            displayValue = " [" .. value .. "]"
            break
        end
    end

    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.new(1, -20, 1, 0)
    txt.Position = UDim2.new(0, 10, 0, 0)
    txt.BackgroundTransparency = 1
    txt.Text = id .. (amount > 1 and " x" .. amount or "") .. displayValue
    txt.TextColor3 = (displayValue ~= "" and Color3.fromRGB(255, 215, 0) or Color3.new(1, 1, 1))
    txt.TextXAlignment = Enum.TextXAlignment.Left
    txt.Font = Enum.Font.GothamMedium
    txt.TextSize = 16
    txt.Parent = btn

    if isOurs then
        btn.MouseButton1Click:Connect(function()
            Trade.RemoveOffer:FireServer(id, itemType)
        end)
    end

    return btn
end

-- CLEAR/RESET FUNCTION
local function ClearAll()
    for _, v in pairs(OurList:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
    for _, v in pairs(TheirList:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
end

-- UPDATE LOGIC
local function UpdateGUI(data)
    ClearAll()
    local p1, p2 = data.Player1, data.Player2
    local ours, theirs = (p1.Player == LocalPlayer and p1.Offer or p2.Offer), (p1.Player == LocalPlayer and p2.Offer or p1.Offer)

    for _, item in pairs(ours) do
        createItem(item[1] or item.ItemID, item[2] or item.Amount or 1, true, item[3] or item.ItemType).Parent = OurList
    end
    for _, item in pairs(theirs) do
        createItem(item[1] or item.ItemID, item[2] or item.Amount or 1, false, item[3] or item.ItemType).Parent = TheirList
    end
    ScreenGui.Enabled = true
end

-- EVENT CONNECTIONS
Trade.UpdateTrade.OnClientEvent:Connect(UpdateGUI)
Trade.StartTrade.OnClientEvent:Connect(function(data)
    ScreenGui.Enabled = true
    UpdateGUI(data)
end)

local function HideUI() ScreenGui.Enabled = false ClearAll() end
Trade.DeclineTrade.OnClientEvent:Connect(HideUI)
Trade.AcceptTrade.OnClientEvent:Connect(function(s) if s then HideUI() end end)

-- DRAGGING LOGIC
local dragging, dragStart, startPos
Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true dragStart = input.Position startPos = MainFrame.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
